<languages />
=Introduction=

==Documentation officielle pour Apptainer==

Cette page ne d√©crit pas toutes les fonctionnalit√©s et ne remplace pas la [http://apptainer.org/docs documentation officielle d'Apptainer]. Nous d√©crivons ici l'utilisation de base, abordons certains aspects de l'utilisation sur nos syst√®mes et pr√©sentons des exemples. Nous vous recommandons de lire la documentation officielle sur les fonctionnalit√©s que vous utilisez.

Pour installer Apptainer sur votre ordinateur, [http://apptainer.org/docs/user/main/quick_start.html#quick-installation consultez cette page]. Si vous utilisez une r√©cente version de Windows, [https://learn.microsoft.com/fr-ca/windows/wsl/install installez d'abord WSL] puis installez Apptainer dans le sous-syst√®me. Si vous utilisez macOS, installez d'abord une distribution Linux dans une machine virtuelle sur votre ordinateur, puis installez Apptainer dans la machine virtuelle.

==Si vous utilisez Singularity==

Nous vous recommandons d'utiliser Apptainer plut√¥t que Singularity. La Fondation Linux a adopt√© SingularityCE (jusqu'√† v3.9.5) et renomm√© Apptainer, avec les modifications suivantes&nbsp;:

* ajout du support pour  [https://dmtcp.sourceforge.io/ DMTCP (<i>Distributed MultiThreaded Checkpointing</i>)];
* abandon du support pour l'option <code>--nvccli</code> en ligne de commande;
* abandon du support pour <code>apptainer build --remote</code>;
* remplacement du point de chute distant SylabsCloud par un point de chute DefaultRemote, sans d√©finition du serveur pour <code>library://</code>;
** au besoin, vous pouvez  [https://apptainer.org/docs/user/1.0/endpoint.html#restoring-pre-apptainer-library-behavior restorer le point de chute distant SylabsCloud];
* remplacement du terme <code>singularity</code> par <code>apptainer</code> dans tous les noms d'ex√©cutables, de chemins, etc.;
** p.ex., la commande  <code>singularity</code> est chang√©e pour <code>apptainer</code>,
** p.ex., le r√©pertoire <code>~/.singularity</code> est chang√© pour <code>~/.apptainer</code>;
* remplacement du terme <code>SINGULARITY</code> par <code>APPTAINER</code> dans toutes les variables d'environnement.

Apptainer version 1 √©tant compatible avec Singularity, vous pouvez utiliser les m√™mes scripts.

==Autres technologies de conteneurs Linux==

Les grappes de calcul haute performance utilisent habituellement Apptainer. En r√©ponse √† plusieurs qui demandent s'il existe d'autres technologies de conteneurs Linux, voici nos commentaires sur quelques-uns&nbsp;:
* [https://podman.io/ Podman] 
** comme Apptainer, supporte l'utilisation des conteneurs normaux (<i>rootless</i>),
** est disponible sous forme de paquet pour les distributions Linux qui supportent RPM, et pour quelques autres;
** m√™me si c‚Äôest une technologie de conteneurs Linux, [https://github.com/containers/podman/blob/main/docs/tutorials/mac_win_client.md Podman peut √™tre install√© sur des ordinateurs Windows et macOS];
** Podman version 4 supporte les fichiers Apptainer .SIF.
* [https://www.docker.com/ Docker]
** Docker ne peut √™tre utilis√© s√©curitairement sur les syst√®mes multi-utilisateurs. Il n‚Äôest donc pas offert sur nos grappes;
** vous pouvez installer Docker sur votre ordinateur et cr√©er une image Apptainer qui sera ensuite t√©l√©vers√©e sur une grappe de calcul haute performance [https://docs.alliancecan.ca/wiki/Apptainer/fr#Cr√©er_un_conteneur_Apptainer_√†_partir_de_Dockerfile comme d√©crit ci-dessous].
<b></b>.

==Autres sujets==
===G√©n√©ralit√©s===
* Vous devez d‚Äôabord avoir une <b>image</b> de votre conteneur, c'est-√†-dire un fichier .sif  ou un r√©pertoire servant de bac √† sable (<i>sandbox</i>). Si ce n‚Äôest pas le cas, voir [[Apptainer/fr#Construire_une_image_Apptainer|Construire une image Apptainer ci-dessous]].
*En plus d‚Äôavoir install√© Apptainer, vous avez aussi besoin d‚Äôinstaller ou de construire tous les logiciels n√©cessaires pour travailler dans le conteneur. [[Available software/fr|Plusieurs logiciels sont d√©j√† install√©s sur nos grappes]] et vous pouvez les utiliser sans cr√©er de conteneur.

===<code>sudo</code>===
Les sites web et la documentation font souvent r√©f√©rence √† <code>sudo</code> pour l‚Äôobtention de permissions de superutilisateur (<i>root</i>), mais ceci n‚Äôest pas possible sur nor grappes. Si vous devez utiliser <code>sudo</code>, vos options sont&nbsp;:

* Installez Linux, Apptainer et <code>sudo</code> dans une machine virtuelle sur un ordinateur que vous contr√¥lez, ce qui vous donnera un acc√®s <code>sudo</code>. Construisez votre ou vos images dans cette machine et t√©l√©versez-les sur une de nos grappes.
* Au besoin, demandez l‚Äôassistance du [[Technical support|soutien technique]] pour construire votre image. S‚Äôil n‚Äôest pas possible de le faire pour vous avec <code>sudo</code>, nous pourrons peut-√™tre vous proposer d‚Äôautres solutions.
* √Ä partir de la version 1.1.x, le support pour l‚Äôutilisation implicite ou explicite de  <code>--fakeroot</code> rend possible des choses qui n‚Äô√©taient pas possibles avec les versions ant√©rieures ou avec Singularity, par exemple la possibilit√© de construire des images √† partir de fichiers de d√©finition  .def ou de construire des images sans avoir recours √† <code>sudo</code>. Ceci dit, il faut se rappeler que ce ne sont pas toutes les images qui peuvent √™tre construites sans <code>sudo</code> ou sans les permissions <i>root</i>.

===Construire des images ou des overlays===
Pour construire vos propres images ou overlays&nbsp;:
* ne construisez pas une image d‚Äôun bac √† sable avec <code>--fakeroot</code> dans un syst√®me de fichiers r√©seau; voir [https://apptainer.org/docs/admin/main/installation.html#lustre-gpfs la documentation officielle d'Apptainer];
* configurez <code>APPTAINER_CACHEDIR</code> pour indiquer un endroit dans un syst√®me de fichiers qui n‚Äòest pas en r√©seau; voir [https://apptainer.org/docs/admin/main/installation.html#lustre-gpfs la documentation officielle d'Apptainer];
* configurez <code>APPTAINER_TMPDIR</code> pour indiquer un endroit dans un syst√®me de fichiers qui n‚Äòest pas de type Lustre/GPFS; voir [https://apptainer.org/docs/admin/main/installation.html#lustre-gpfs la documentation officielle d'Apptainer];
* n‚Äôutilisez pas les syst√®mes de fichiers qui sont de type Lustre/GPFS parce qu‚Äôils n‚Äôoffrent pas les fonctionnalit√©s n√©cessaires pour la construction de conteneurs (en particulier <code>--fakeroot</code>); voir [https://apptainer.org/docs/admin/main/installation.html#lustre-gpfs la documentation officielle d'Apptainer].

=Charger le module Apptainer=
Pour utiliser la version disponible par d√©faut, lancez
<source lang="console">$ module load apptainer</source>

Pour conna√Ætre toutes les versions disponibles, lancez
<source lang="console">$ module spider apptainer</source>

=Ex√©cuter des programmes dans un conteneur=

==Options de ligne de commande √† retenir==

Les logiciels ex√©cut√©s dans un conteneur se trouvent dans un environnement qui utilise des biblioth√®ques et outils diff√©rents de ceux install√©s dans le syst√®me h√¥te. Il est donc important que les programmes ex√©cut√©s dans un conteneur <b>n‚Äôutilisent pas de param√®tres de configuration ou de logiciels d√©finis hors du conteneur</b>. Cependant, Apptainer adopte par d√©faut l‚Äôenvironnement de l‚Äôinterpr√©teur de l‚Äôh√¥te, ce qui peut causer des probl√®mes √† l‚Äôex√©cution de certains programmes. Les options suivantes utilis√©es avec <code>apptainer run</code>, <code>apptainer shell</code>, <code>apptainer exec</code>, et/ou <code>apptainer instance</code> √©vitent ces probl√®mes.

{| class="wikitable"
|+Options en ligne de commande

|-
| <code>-C</code> || Isole le conteneur actif de <b>tous les syst√®mes de fichiers</b>, du PID parent, des IPC et de l‚Äôenvironnement. Pour acc√©der aux syst√®mes de fichiers √† l‚Äôext√©rieur du conteneur, vous devez utiliser des [https://docs.alliancecan.ca/wiki/Apptainer/fr#Bind_mounts bind mounts].
|-
| <code>-c</code> ||Isole le conteneur actif de <b>la plupart des syst√®mes de fichiers</b> en n‚Äôutilisant qu‚Äôun r√©pertoire <code>/dev</code> minimal, un r√©pertoire <code>/tmp</code> vide et un r√©pertoire <code>/home</code> vide.Pour acc√©der aux syst√®mes de fichiers √† l‚Äôext√©rieur du conteneur, vous devez utiliser des [https://docs.alliancecan.ca/wiki/Apptainer/fr#Bind_mounts bind mounts].
|-
| <code>-e</code> || Supprime certaines variables de l‚Äôenvironnement de l‚Äôinterpr√©teur avant le lancement des commandes et configure les param√®tres pour une meilleure compatibilit√© OCI/Docker. Cette option ajoute implicitement <code>--containall</code>, <code>--no-init</code>, <code>--no-umask</code> et <code>--writable-tmpfs</code>.
|}

Une autre importante option est  <code>-W</code> ou <code>--workdir</code>. Sur nos grappes et avec la plupart des syst√®mes Linux, les syst√®mes de fichiers semblables √† <code>/tmp</code> utilisent la m√©moire RAM et non l‚Äôespace sur disque. Les t√¢ches ex√©cut√©es sur nos grappes disposent habituellement de peu de m√©moire RAM et elles sont annul√©es si elles consomment plus de m√©moire que ce qui a √©t√© allou√©. Pour contourner ce probl√®me, Apptainer doit utiliser un disque physique pour son r√©pertoire de travail  (<code>workdir</code>). Pour ce faire, on utilise l‚Äôoption <code>-W</code> suivie du chemin vers un disque o√π Apptainer peut lire et √©crire des fichiers temporaires. Dans l‚Äôexemple suivant, la commande myprogram dans l‚Äôimage du conteneur  <code>myimage.sif</code> sp√©cifie le r√©pertoire de travail <code>/path/to/a/workdir.
apptainer run -C -B /project -W /path/to/a/workdir myimage.sif myprogram</code>.

<source lang="console">apptainer run -C -B /project -W /path/to/a/workdir myimage.sif myprogram</source>

o√π
* l'option <code>workdir</code> peut √™tre supprim√©e si aucun conteneur actif ne l‚Äôutilise.
* quand Apptainer est utilis√© dans une t√¢che lanc√©e avec <code>salloc</code>, <code>sbatch</code>, ou [[JupyterHub/fr|JupyterHub]] sur nos grappes, le r√©pertoire de travail doit √™tre <code>${SLURM_TMPDIR}</code>, par exemple <code>-W ${SLURM_TMPDIR}</code>.
** Note : Aucun programme intensif (incluant Apptainer) ne doit √™tre ex√©cut√© sur les n≈ìuds de connexion. Utilisez plut√¥t <code>salloc</code>pour d√©marrer  une t√¢che interactive.
* les bind mounts ne fonctionnent pas de la m√™me mani√®re sur toutes nos grappes; consultez [https://docs.alliancecan.ca/wiki/Apptainer/fr#Bind_mounts_et_overlays_persistants Bind mounts et overlays persistants ci-dessous] pour savoir comment acc√©der √† <code>/home</code>, <code>/project</code>, et <code>/scratch</code>.

==Utiliser des GPU==

Tenez compte des points suivants quand votre logiciel dans un conteneur requiert l‚Äôutilisation de GPU&nbsp;:
*Assurez-vous de passer <code>--nv</code> (pour le mat√©riel NVIDIA) et <code>--rocm</code> (pour le mat√©riel AMD) aux commandes Apptainer.
**Ces options font en sorte que les entr√©es appropri√©es dans <code>/dev</code> soient incluses dans le bind mount √† l‚Äôint√©rieur du conteneur.
**Ces options localisent les biblioth√®ques pour les GPU et les attachent √† l‚Äôh√¥te, en plus de configurer la variable d‚Äôenvironnement <code>LD_LIBRARY_PATH</code> pour que les biblioth√®ques fonctionnent dans le conteneur.
*Assurez-vous que l‚Äôapplication qui utilise le GPU dans le conteneur a √©t√© correctement compil√©e pour pouvoir utiliser le GPU et ses biblioth√®ques.
*Pour utiliser OpenCL dans le conteneur, utilisez les options pr√©c√©dentes et ajoutez le bind mount <code>-B /etc/OpenCL</code>.

Voyez l'exemple sous [https://docs.alliancecan.ca/wiki/Apptainer/fr#Travailler_avec_des_GPU_NVIDIA  Travailler avec des GPU NVIDIA ci-dessous].

==Lancer des programmes MPI==

Pour lancer des programmes MPI dans un conteneur, il faut ajuster certaines choses dans l‚Äôenvironnement h√¥te. Voyez un exemple dans  [https://docs.alliancecan.ca/wiki/Apptainer/fr#Travailler_avec_des_programmes_MPI  Travailler avec des programmes MPI ci-dessous]. Vous trouverez plus d‚Äôinformation dans [https://apptainer.org/docs/admin/main/installation.html#lustre-gpfs la documentation officielle d'Apptainer].

==Aide avec <code>apptainer run-help</code>==

Les conteneurs Apptainer construits √† partir de [http://apptainer.org/docs/user/main/definition_files.html fichiers de d√©finition]  ont souvent une fonctionnalit√© <code>%help</code> appel√©e comme suit

 apptainer run-help your-container-name.sif

o√π
* <code>your-container-name.sif</code> est le nom du conteneur.

Si votre conteneur a aussi des applications, lancez

 apptainer run-help --app appname your-container-name.sif

o√π
* <code>appname</code> est le nom de l'application
* <code>your-container-name.sif</code> est le nom du conteneur

Pour obtenir la liste des applications qui se trouvent dans le conteneur, lancez

 apptainer inspect --list-apps your-container-name.sif

o√π 
* <code>your-container-name.sif</code> est le nom du conteneur.

==Lancer un logiciel avec <code>apptainer run</code> ou <code>apptainer exec</code>==

La commande <code>apptainer run</code> lance le conteneur, ex√©cute le script <code>%runscript</code> d√©fini pour ce conteneur (s‚Äôil y en a un), puis lance la commande sp√©cifi√©e.
Pour sa part, la commande <code>apptainer exec,</code> ne va pas ex√©cuter le script, m√™me s‚Äôil est d√©fini dans le conteneur.

Nous recommandons de toujours utiliser <code>apptainer run</code>.

Supposons maintenant que vous voulez compiler avec <code>g++</code>  le programme C++ <code>myprog.cpp</code> qui se trouve dans un conteneur, pour ensuite lancer le programme.  Vous pouvez utiliser

 apptainer run your-container-name.sif g++ -O2 -march=broadwell ./myprog.cpp
 apptainer run your-container-name.sif ./a.out

o√π
* <code>your-container-name.sif</code>  est le nom du fichier .SIF
* <code>g++ -O2 -march=broadwell ./myprog.cpp</code> est la commande √† ex√©cuter dans le conteneur.

Sur nos grappes, vous devrez ajouter des options apr√®s <code>run</code>, mais avant <code>your-container-name.sif</code>, dont - <code>-C</code>, <code>-c</code>, <code>-e</code> et <code>-W</code> en plus de certaines options bind mount pour que l‚Äôespace disque soit disponible pour les programmes dans le conteneur, par exemple

  apptainer run -C -W $SLURM_TMPDIR -B /project -B /scratch your-container-name.sif g++ -O2 -march=broadwell ./myprog.cpp
  apptainer run -C -W $SLURM_TMPDIR -B /project -B /scratch ./a.out

Pour plus d'information, consultez

* [https://docs.alliancecan.ca/wiki/Apptainer/fr#Options_de_ligne_de_commande_√†_retenir Options de ligne de commande √† retenir]
* [https://docs.alliancecan.ca/wiki/Apptainer/fr#Utiliser_des_GPU Utiliser des GPU]
* [https://docs.alliancecan.ca/wiki/Apptainer/fr#Bind_mounts_et_overlays_persistants Bind mounts et overlays persistants]

Consultez aussi la [http://apptainer.org/docs/user/main/index.html documentation officielle pour Apptainer].

==Interactivit√©  avec <code>apptainer shell</code>==

Les commandes <code>apptainer run</code>, <code>apptainer exec</code> et <code>apptainer instance</code> ex√©cutent imm√©diatement les programmes, ce qui est parfait dans les scripts de t√¢ches pour BASH et Slurm. Il peut parfois √™tre n√©cessaire de travailler interactivement dans un conteneur; pour ce faire, utilisez la commande <code>apptainer shell</code>.

Par exemple

 apptainer shell your-container-name.sif

o√π
* <code>your-container-name.sif</code> est le nom de votre fichier SIF

Quand le conteneur est pr√™t, l‚Äôinvite  <code>Apptainer&gt;</code> s‚Äôaffichera (ou <code>Singularity&gt;</code> dans le cas des versions ant√©rieures). Entrez alors les commandes pour l‚Äôinterpr√©teur, puis entrez <code>exit</code> et appuyez sur la touche Enter/Return pour sortir du conteneur.

Sur nos grappes, vous devrez ajouter des options apr√®s <code>run</code>, mais avant <code>your-container-name.sif</code>, dont - <code>-C</code>, <code>-c</code>, <code>-e</code> et <code>-W</code> en plus de certaines options bind mount pour que l‚Äôespace disque soit disponible pour les programmes dans le conteneur, par exemple

  apptainer shell -C -W $SLURM_TMPDIR -B /home:/cluster_home -B /project -B /scratch your-container-name.sif

Pour plus d'information, consultez

* [https://docs.alliancecan.ca/wiki/Apptainer/fr#Options_de_ligne_de_commande_√†_retenir Options de ligne de commande √† retenir]
* [https://docs.alliancecan.ca/wiki/Apptainer/fr#Utiliser_des_GPU Utiliser des GPU]
* [https://docs.alliancecan.ca/wiki/Apptainer/fr#Bind_mounts_et_overlays_persistants Bind mounts et overlays persistants]

Consultez aussi la [http://apptainer.org/docs/user/main/index.html documentation officielle d'Apptainer].

<b>IMPORTANT :</b> Si vous utilisez une image d‚Äôun overlay persistant (dans un fichier SIF ou un fichier distinct) et que vous voulez que cette image refl√®te les modifications, il faut, en plus des options nomm√©es ci-dessus, passer au conteneur l‚Äôoption <code>-w</code> ou <code>--writable</code>, autrement les modifications faites dans la session code>apptainer shell</code> ne seront pas sauvegard√©es.

==Utiliser des d√©mons avec <code>apptainer instance</code>==


Apptainer est con√ßu pour ex√©cuter correctement des d√©mons pour des t√¢ches de calcul sur des grappes, en partie √† l‚Äôaide de la commande <code>apptainer instance</code>. Voir les d√©tails dans [http://apptainer.org/docs/user/main/running_services.html Running Services] de la documentation officielle.

<b>Remarque 1 :</b> N‚Äôex√©cutez pas manuellement un d√©mon sans utiliser <code>apptainer instance</code> et les autres commandes reli√©es. Apptainer fonctionne bien avec d‚Äôautres outils comme l‚Äôordonnanceur Slurm employ√© sur nos grappes. Quand une t√¢che plante, est annul√©e ou se termine de toute autre fa√ßon, les d√©mons lanc√©s avec <code>apptainer instance</code> ne seront pas bloqu√©s et ne laisseront pas de processus d√©funts. Aussi, la commande <code>apptainer instance</code> vous permet de contr√¥ler les d√©mons et les programmes qui sont ex√©cut√©s dans un m√™me conteneur.

<b>Remarque 2 :</b> Les d√©mons ne sont ex√©cut√©s que lorsque la t√¢che est en marche. Si l'ordonnanceur annule la t√¢che, tous les d√©mons qui lui sont rattach√©s seront aussi annul√©s. Si vous avez besoin de d√©mons qui restent actifs au-del√† du temps d‚Äôex√©cution,vous pouvez √† la place les ex√©cuter  dans une machine virtuelle, dans un nuage; contactez alors le [[Technical support/fr|soutien technique]].

==Travailler avec des programmes MPI==

L‚Äôex√©cution de programmes MPI sur des n≈ìuds dans un conteneur Apptainer requiert une configuration particuli√®re. La communication entre les n≈ìuds est beaucoup plus efficace avec MPI en raison de sa bonne utilisation du mat√©riel d‚Äôinterconnexion. Ceci se fait habituellement de fa√ßon automatique et ne cause aucun souci, sauf quand le programme utilise plusieurs n≈ìuds dans une grappe.

<b>Remarque :</b>  Quand tous les processus MPI sont ex√©cut√©s dans un conteneur Apptainer sur un seul n≈ìud √† m√©moire partag√©e, le mat√©riel d'interconnexion n‚Äôest pas sollicit√© et aucun probl√®me ne survient, par exemple avec l‚Äôoption  <code>--nodes=1</code> dans un script <code>sbatch</code>. Par contre, si le nombre de n≈ìuds n'est pas <b>explicitement d√©fini</b> comme √©tant <code>1</code>, l‚Äôordonnanceur peut choisir d‚Äôex√©cuter le programme MPI sur plusieurs n≈ìuds et il est possible que la t√¢che ne puisse pas √™tre ex√©cut√©e.

(contenu en pr√©paration)

=Bind mounts et overlays persistants=

Apptainer offre les fonctionnalit√©s suivantes :
* <b>bind mounts</b>, pour avoir acc√®s √† l‚Äôespace disque √† l‚Äôext√©rieur du conteneur;
* <b>persistent overlays</b>, pour superposer un syst√®me de fichiers en lecture/√©criture √† un conteneur immuable (lecture seulement).

==Bind mounts==

L'utilisation des options  <code>-C</code> ou <code>-c</code>  avec un conteneur emp√™che l‚Äôacc√®s √† votre espace disque. Pour y pallier, il faut explicitement demander le  bind mount de cet espace. Supposons que l‚Äôoption <code>-C</code> est utilis√©e dans une t√¢che

 apptainer run -C -W $SLURM_TMPDIR a-container.sif wc -l ./my_data_file.txt

o√π <code>./my_data_file.txt</code> est un fichier dans le r√©pertoire courant de l‚Äôh√¥te, c‚Äôest-√†-dire que le fichier n‚Äôest pas situ√© dans le conteneur. L‚Äôoption <code>-C</code> fait en sorte que le programme <code>wc</code> dans le conteneur n'aura pas acc√®s au fichier et une erreur d‚Äôacc√®s surviendra. Pour √©viter ceci, il faut faire un bind mount du r√©pertoire courant

 apptainer run -C -B . -W $SLURM_TMPDIR a-container.sif wc -l ./my_data_file.txt

o√π <code>-B .</code> fait le bind mount du r√©pertoire courant <code>.</code>.

M√™me s‚Äôil est possible de cr√©er plusieurs bind mount, il est souvent plus simple de faire le bind mount du r√©pertoire de niveau sup√©rieur sous lequel les r√©pertoires sont situ√©s. Par exemple, sur nos grappes, vous pouvez utiliser

 apptainer run -C -B /project -B /scratch -W $SLURM_TMPDIR a-container.sif wc -l ./my_data_file.txt

o√π 
* <code>-B /project</code> fait le bind mount du syst√®me de fichiers /project 
* <code>-B /scratch</code> fait le bind mount du syst√®me de fichiers /scratch

Ceci est particuli√®rement utile 
*pour avoir acc√®s aux fichiers des autres membres de votre √©quipe,
*pour avoir acc√®s aux fichiers et r√©pertoires dont certains sont des <code>symlinks</code> vers diff√©rents endroits et qui pourraient √™tre inaccessibles si le bind mount n‚Äôest pas fait pour le syst√®me de fichiers au complet.

Si les bind mount ne fonctionnent pas sur la grappe que vous utilisez, lancez le script suivant pour obtenir les options qui doivent √™tre pass√©es √† Apptainer.

 /home/preney/public/apptainer-scripts/get-apptainer-options.sh

Le bind mount ne doit pas n√©cessairement √™tre au m√™me endroit dans le conteneur. Vous pouvez faire le bind mount d‚Äôun fichier ou d‚Äôun r√©pertoire ailleurs, par exemple

 apptainer run -C -B ./my_data_file.txt:/special/input.dat -W $SLURM_TMPDIR a-container.sif wc -l /special/input.dat

o√π le bind mount <code>-B ./my_data_file.txt:/special/input.dat</code> associe le fichier <code>./my_data_file.txt</code> au fichier <code>/special/input.dat</code> dans le conteneur, pour √™tre trait√© avec la commande <code>wc</code>. Ceci est utile quand des programmes ou des scripts dans un conteneur contiennent des chemins fig√©s dans le code (<i>hard coded</i>) vers des fichiers ou des r√©pertoires qui sont situ√©s ailleurs.

Si vous avez besoin de faire le bind mount du syst√®me de fichiers /home dans votre conteneur, utilisez un autre r√©pertoire de destination comme

* <code>-B /home:/cluster_home</code>

Ceci fait en sorte que les fichiers de configuration et les programmes qui sont dans votre r√©pertoire /home n'interf√®reront pas avec les logiciels dans votre conteneur. √Ä l‚Äôinverse, si vous utilisez <code>-B /home</code>, les programmes dans <code>$HOME/bin</code> et les paquets Python dans <code>$HOME/.local/lib/python3.x</code> pourraient √™tre utilis√©s plut√¥t que les fichiers correspondants du conteneur.

Enfin, <b>√©vitez de faire le bind mount de CVMFS dans vos conteneurs</b>.  Les programmes fournis par CVMFS peuvent √™tre incompatibles avec vos conteneurs. L‚Äôobjectif d‚Äôun conteneur est de fournir un environnement complet qui ne d√©pend pas de logiciels externes. Les programmes ex√©cut√©s dans un conteneur devraient s‚Äôy trouver en entier et ceux qui ne sont pas n√©cessaires ne devraient pas y √™tre ajout√©s.

==Overlays persistants==

Voir les d√©tails dans [https://apptainer.org/docs/user/main/persistent_overlays.html Persistent Overlays] de la documentation officielle.

=Construire une image Apptainer=

<b>ATTENTION :</b> Lisez d‚Äôabord les  recommandations ci-dessus dans [https://docs.alliancecan.ca/wiki/Apptainer/fr#Construire_des_images_ou_des_overlays Construire des images ou des overlays] ci-dessus.

Une image Apptainer peut √™tre

* un fichier <code>SIF</code> ou 
* un r√©pertoire servant de bac √† sable (<i>sandbox</i>).

Un fichier SIF peut contenir un ou plusieurs syst√®mes de fichiers <code>squashfs</code> compress√©s et en lecture seule. Il est aussi possible qu‚Äôun fichier <code>SIF</code>  contienne des fichiers en lecture-√©criture et/ou des images overlay, mais nous n‚Äôabordons pas ces cas ici; consultez plut√¥t [https://apptainer.org/docs/admin/main/installation.html#lustre-gpfs la documentation officielle d'Apptainer]. √Ä moins d‚Äôemployer des m√©thodes plus complexes pour cr√©er une image, la commande Apptainer code>build</code> produit un fichier SIF compos√© d‚Äôun syst√®me de fichiers <code>squashfs</code> en lecture seule. Ceci est la meilleure option, car l‚Äôimage en lecture seule restera telle quelle et elle sera plus compacte; il faut se rappeler que les op√©rations de lecture de cette image se font √† tr√®s grande vitesse.

<b>Un r√©pertoire bac √† sable</b> est un r√©pertoire ordinaire qui est vide au d√©but et auquel Apptainer ajoute les fichiers et les r√©pertoires au fur et √† mesure que l‚Äôimage est construite. L‚Äôacc√®s au r√©pertoire et sa mise √† jour doivent se faire uniquement via Apptainer. Un bac √† sable est utile quand il faut acc√©der √† l‚Äôimage en lecture-√©criture  pour la modifier. Par contre, si les modifications sont peu fr√©quentes, il est pr√©f√©rable d‚Äôutiliser un fichier <code>SIF</code>. Il est possible de construire une image, faire des modifications puis construire un nouveau fichier <code>SIF</code> pour l‚Äôimage modifi√©e, par exemple

<source lang="console">$ cd $HOME
$ mkdir mynewimage.dir
$ apptainer build mynewimage.dir myimage.sif
$ apptainer shell --writable mynewimage.dir
Apptainer> # Run commands to update mynewimage.dir here.
Apptainer> exit
$ apptainer build newimage.sif mynewimage.dir
$ rm -rf mynewimage.dir</source>

L‚Äôutilisation d‚Äôun fichier <code>SIF</code> est recommand√©e car la performance √† partir de l‚Äôimage du conteneur est plus rapide que lorsque chaque fichier  est stock√© s√©par√©ment dans les syst√®mes de fichiers de nos grappes, qui sont optimis√©s pour traiter des fichiers de grande taille et pour les op√©rations parall√®les de lecture et d‚Äô√©criture. Aussi, contrairement √† une image SIF, un bac √† sable aura un impact important sur le nombre de fichiers que vous stocker, alors que ce nombre est limit√© par un quota. (Certaines images peuvent contenir des milliers de fichiers et de r√©pertoires.)

Les permissions <i>root</i> sont requises pour l‚Äôutilisation des gestionnaires de paquets des distributions Linux; un simple utilisateur ne peut donc pas construire des images sur nos grappes de calcul avec Apptainer 1.0.x et les versions Singularity pr√©c√©dentes. Au besoin, √©crivez au [[Technical support/fr|soutien technique]] pour de l‚Äôassistance dans la cr√©ation de votre image ou utilisez un ordinateur o√π Apptainer est install√© et o√π vous avez les permissions <i>root</i>.

L‚Äôoption <code>--fakeroot</code> d‚ÄôApptainer est utilis√©e pour cr√©er et manipuler des images. Avec les versions ant√©rieures √†  1.1, il faut contacter le [[Technical support/fr|soutien technique]] et demander qu‚Äôun administrateur accorde la permission d‚Äôutiliser <code>--fakeroot</code> sur la grappe utilis√©e, ce qui n‚Äôest pas toujours possible. Avec Apptainer version 1.1, <code>--fakeroot</code> peut √™tre utilis√©e sans permission suppl√©mentaire.

Certains conteneurs ne peuvent √™tre cr√©√©s si vous n‚Äôavez pas les permissions <i>root</i>. De tels conteneurs ne peuvent pas √™tre construits sur nos grappes.

Si tout ce dont vous avez besoin est une image Docker telle quelle, vous pourrez souvent la construire et l‚Äôex√©cuter facilement sans les permissions <i>root</i> et sans l‚Äôutilisation de <code>--fakeroot</code>.  Si par la suite vous devez modifier l‚Äôimage, vous devrez peut-√™tre avoir les permissions <i>root</i>, par exemple pour utiliser un gestionnaire de paquets. Pour cette raison, les exemples suivants supposent l‚Äôutilisation d'une image Docker telle quelle.

==Construire une image SIF==

<b>ATTENTION :</b> Veuillez tenir compte des recommandations faites dans [https://docs.alliancecan.ca/wiki/Apptainer/fr#Construire_des_images_ou_des_overlays Construire des images ou des overlays] ci-dessus.

Pour construire l‚Äôimage d‚Äôun fichier SIF avec la plus r√©cente image busybox de Docker, lancez
<source lang="console">$ apptainer build bb.sif docker://busybox</source>

Pour des fonctions plus avanc√©es, voir [https://apptainer.org/docs/admin/main/installation.html#lustre-gpfs la documentation officielle d'Apptainer].

==Construire un bac √† sable==

<b>ATTENTION :</b> Veuillez tenir compte des recommandations faites dans [https://docs.alliancecan.ca/wiki/Apptainer/fr#Construire_des_images_ou_des_overlays Construire des images ou des overlays] ci-dessus.

Pour construire un bac √† sable plut√¥t qu‚Äôun fichier SIF, remplacez le nom du fichier SIF par <code>--sandbox DIR_NAME</code> ou <code>-s DIR_NAME</code> o√π <code>DIR_NAME</code> est le nom du r√©pertoire √† cr√©er pour le bac √† sable.  Par exemple, pour cr√©er un fichier SIF avec <code>apptainer build</code>, la commande est
<source lang="console">$ apptainer build bb.sif docker://busybox</source>
Remplacez <code>bb.sif</code> par un nom de r√©pertoire, par exemple <code>bb.dir</code>, avec l‚Äôoption  <code>--sandbox</code>.
<source lang="console">$ apptainer build --sandbox bb.dir docker://busybox</source>

Rappelons les  diff√©rences entre un fichier SIF et un bac √† sable&nbsp;:

*l‚Äôimage du conteneur est contenue dans un seul fichier SIF compress√©, en lecture seule,
*les fichiers individuels formant l‚Äôimage du conteneur sont plac√©s dans un r√©pertoire servant de bac √† sable. Ces fichiers ne sont pas compress√©s, peuvent √™tre nombreux (plusieurs milliers) et sont accessibles en lecture-√©criture.

L‚Äôutilisation d‚Äôun bac √† sable entame significativement vos quotas d‚Äôespace disque et de nombre de fichiers. Si vous n‚Äôavez pas besoin d‚Äôun acc√®s en lecture et en √©criture fr√©quent √† l‚Äôimage du conteneur, il est recommand√© d‚Äôutiliser un fichier SIF. Ce dernier offre aussi un acc√®s plus rapide.

=Cas d'usage=

==Travailler avec Conda ==

Avant de commencer ce tutoriel, prenez note de quelques points importants&nbsp;:

* Utilisez Conda <b>en dernier recours</b>, m√™me dans un conteneur. Accordez plut√¥t la priorit√© aux [[Modules/fr|modules]] de notre [[Available software/fr|pile logicielle]] et aux [[Python/fr|wheels]] parmi [[Available Python wheels/fr|ceux qui sont disponibles]]. Ces modules et wheels sont optimis√©s en fonction de nos syst√®mes et nous pouvons fournir une meilleure assistance au besoin. Pour faire ajouter un module ou un paquet, contactez le [[Technical support/fr|soutien technique]].
* Dans ce tutoriel, nous utilisons le gestionnaire de paquets [https://mamba.readthedocs.io/en/latest/user_guide/micromamba.html micromamba] au lieu de Conda. Si vous voulez utiliser Conda, vous devez tenir compte des  [https://legal.anaconda.com/policies/en?name=terms-of-service#terms-of-service conditions d'utilisation d'Anaconda] et peut-√™tre  [https://www.anaconda.com/pricing/terms-of-service-faqs d√©tenir une licence commerciale].
* Dans ce tutoriel, nous cr√©ons une image pour lecture seule, c'est-√† dire un fichier <tt>.sif</tt> qui contient un environnement Conda avec tout ce qu'il faut pour utiliser votre application. Il est fortement recommand√© de <b>ne pas installer interactivement un logiciel dans un conteneur avec Conda</b> et aucune information ne sera donn√©e en ce sens.

La cr√©ation d'une image Apptainer et l'installation d'un logiciel dans un conteneur avec Conda est un processus en trois √©tapes.<br>
Il faut d'abord cr√©er un fichier <tt>.yml</tt> qui d√©crit l'environnement Conda √† cr√©er dans le conteneur; dans l'exemple suivant, il s'agit de <tt>environment.yml</tt>. Ce fichier contient le nom de l'environnement √† cr√©er, la liste des paquets √† installer et comment les trouver (<i>channel</i>).

{{File
  |name=environment.yml
  |lang="yaml"
  |contents=
name: base
channels:
  - conda-forge
  - bioconda
  - defaults
dependencies:
  - python
  - pip
  - star
  - bwa
  - multiqc
}}

Il faut ensuite cr√©er un  [https://apptainer.org/docs/user/main/definition_files.html fichier de d√©finition pour l'image] (nomm√© ici <tt>image.def</tt>) qui d√©crit les √©tapes pour cr√©er l'image avec Apptainer.
#T√©l√©chargez une image Docker de DockerHub qui contient le gestionnaire de paquets micromamba pr√©install√©.
#Cr√©ez dans le conteneur une copie du fichier de d√©finition <tt>environment.yml</tt>.
#Ex√©cutez micromamba pour configurer l'environnement <tt>environment.yml</tt>.

{{File
  |name=image.def
  |lang="yaml"
  |contents=
Bootstrap: docker
From: mambaorg/micromamba:latest

%files
    environment.yml /environment.yml

%post
    micromamba install -n base --file environment.yml && \
        micromamba clean --all --yes
}}

La derni√®re √©tape est de construire l'image Apptainer √† l'aide du fichier de d√©finition ci-dessus&nbsp;:
   module load apptainer
   APPTAINER_BIND=' ' apptainer build image.sif image.def

Vous pouvez maintenant tester si <code>multiqc</code> est disponible avec, par exemple, la commande
{{Command
|apptainer run image.sif multiqc --help
|result=
 
 /// MultiQC üéÉ v1.25.1
 
 Usage: multiqc [OPTIONS] [ANALYSIS DIRECTORY]
...
}}

==Travailler avec Spack ==

(contenu en pr√©paration)

==Travailler avec des GPU NVIDIA ==

(contenu en pr√©paration)

==Travailler avec MPI==

(contenu en pr√©paration)

==Cr√©er un conteneur Apptainer √† partir de Dockerfile==

<b>Remarque : Il faut d‚Äôabord installer Docker et Apptainer sur un ordinateur o√π vous disposez des permissions n√©cessaires. Les commandes pr√©sent√©es ici ne fonctionnent pas sur nos grappes.</b>

Malheureusement, certains projets logiciels offrent un fichier d‚Äôinstructions Dockerfile mais pas d‚Äôimage de conteneur. Il faut alors cr√©er une image √† partir du fichier Dockerfile. Cependant, Docker n‚Äôest pas install√© sur nos grappes. Ceci dit, si vous pouvez travailler avec un ordinateur o√π Docker et Apptainer sont install√©s et o√π vous avez les permissions suffisantes (acc√®s <i>root</i> ou <code>sudo</code>, ou appartenance au groupe <code>docker</code> et permission <code>--fakeroot</code>) , les commandes suivantes vous permettront d'utiliser Docker puis Apptainer pour construire une image Apptainer sur cet ordinateur.

Remarque : Docker pourrait planter si vous ne faites pas partie du groupe <code>docker</code>. Il pourrait aussi s‚Äôav√©rer impossible de cr√©er certains conteneurs sans les permissions <i>root</i>,  <code>sudo</code> ou <code>--fakeroot</code>. V√©rifiez que vous poss√©dez les permissions n√©cessaires.

Si vous n'avez qu'un Dockerfile et que vous voulez cr√©er une image Apptainer, lancez la commande suivante sur un ordinateur o√π Docker et Apptainer sont install√©s et o√π vous disposez des permissions n√©cessaires.

 docker build -f Dockerfile -t your-tag-name
 docker save your-tag-name -o your-tarball-name.tar
 docker image rm your-tag-name
 apptainer build --fakeroot your-sif-name.sif docker-archive://your-tarball-name.tar
 rm your-tarball-name.tar

o√π

*<code>your-tag-name</code> est le nom √† donner au conteneur Docker,
*<code>your-tarball-name.tar</code> est le nom √† donner au fichier dans lequel Docker sauvegardera le contenu g√©n√©r√© pour le conteneur,
*<code>--fakeroot</code> peut √™tre omis si c‚Äôest optionnel; pour utiliser plut√¥t <code>sudo</code>, omettez <code>--fakeroot</code> et ajoutez <code>sudo</code>en pr√©fixe √† la ligne,
*<code>your-sif-name.sif</code> est le nom du fichier SIF pour le conteneur Apptainer.

Le fichier SIF r√©sultant est un conteneur Apptainer correspondant aux instructions Dockerfile. Copiez le fichier SIF sur la ou les grappes que vous voulez utiliser.

<b>Remarque :</b> Il est possible que le Dockerfile ajoute des couches additionnelles; vous n‚Äôavez qu‚Äô√† les supprimer avec

 docker images

puis <code>docker image rm ID</code> (o√π ID est l‚Äôidentifiant de l‚Äôimage obtenue par la commande <code>docker images</code>). Ceci lib√®re l‚Äôespace disque occup√© par les couches additionnelles.

=Sujets divers=

==Vider le r√©pertoire cache==

Pour trouver les fichiers du r√©pertoire cache, lancez

 apptainer cache list

Supprimez les fichiers avec

 apptainer cache clean

==Modifier les r√©pertoires par d√©faut==

Avant de lancer Apptainer, configurez les variables d‚Äôenvironnement suivantes pour utiliser d‚Äôautres r√©pertoires temporaires et cache que ceux d√©sign√©s par d√©faut.

* <code>APPTAINER_CACHEDIR</code> : r√©pertoire o√π les fichiers sont t√©l√©charg√©s et mis en cache par Apptainer
* <code>APPTAINER_TMPDIR</code> : r√©pertoire o√π Apptainer enregistre les fichiers temporaires, incluant pour la cr√©ation d‚Äôimages <code>squashfs</code>

Par exemple, pour qu‚ÄôApptainer utilise votre espace /scratch pour la cache et les fichiers temporaires (ce qui est probablement le meilleur endroit), utilisez

 $ mkdir -p /scratch/$USER/apptainer/{cache,tmp}
 $ export APPTAINER_CACHEDIR="/scratch/$USER/apptainer/cache"
 $ export APPTAINER_TMPDIR="/scratch/$USER/apptainer/tmp"

avant de lancer Apptainer.