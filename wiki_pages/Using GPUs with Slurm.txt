<languages />
<translate>

= Introduction = <!--T:56-->

<!--T:57-->
To request one or more GPUs for a Slurm job, use this form:
  --gpus-per-node=[type:]number

<!--T:58-->
The square-bracket notation means that you must specify the number of GPUs, and you may optionally specify the GPU type.  Valid types are listed in the <i>Available GPUs</i> table below, in the column headed "Slurm type specifier".  Here are two examples:
  --gpus-per-node=2
  --gpus-per-node=v100:1

<!--T:59-->
The first line requests two GPUs per node, of any type available on the cluster.  The second line requests one GPU per node, with the GPU being of the V100 type.

<!--T:60-->
The following form can also be used:
  --gres=gpu[[:type]:number]
This is older, and we expect it will no longer be supported in some future release of Slurm.  We recommend that you replace it in your scripts with the above <code>--gpus-per-node</code> form.

<!--T:61-->
There are a variety of other directives that you can use to request GPU resources: <code>--gpus</code>, <code>--gpus-per-socket</code>, <code>--gpus-per-task</code>, <code>--mem-per-gpu</code>, and <code>--ntasks-per-gpu</code>.  Please see the Slurm documentation for [https://slurm.schedmd.com/sbatch.html sbatch] for more about these.  Our staff did not test all the combinations; if you don't get the result you expect, [[Technical support|contact technical support]].

<!--T:15-->
For general advice on job scheduling, see [[Running jobs]].

<!--T:1-->
= Available GPUs =
These are the GPUs currently available:

<!--T:2-->
{| class="wikitable"
|-
! Cluster !! Specifications !! Slurm type<br>specifier !! GPU model  !! Compute<br>Capability(*) !! Notes
|- 
| Fir   || [[Fir#Node_characteristics|<b>Details</b>]] || [[Multi-Instance_GPU#Available_configurations|<b>Options</b>]]
|| H100-80gb    || 90   || Two GPUs per CPU socket; all GPUs connected via NVLink
|-
| Narval           || [[Narval/en#Node_characteristics|<b>Details</b>]]
|| [[Narval/en#GPU_instances|<b>Options</b>]] || A100-40gb || 80 || Two GPUs per CPU socket; all GPUs connected via NVLink 
|- 
| rowspan=2|Nibi   || rowspan=2|[[Nibi#Node_characteristics|<b>Details</b>]] || rowspan=2|[[Multi-Instance_GPU#Available_configurations|<b>Options</b>]]
|| H100-80gb    || 90   || Two GPUs per CPU socket; all GPUs connected via NVLink
|-
|| MI300A-128gb || N.A. || Unified memory between CPU and GPU
|- 
| Rorqual          || [[Rorqual/en#Node_characteristics|<b>Details</b>]]
|| [[Rorqual/en#GPU_instances|<b>Options</b>]] || H100-80gb || 90 || Two GPUs per CPU socket; all GPUs connected via NVLink
|-
| Trillium          || [[Trillium#Node_characteristics|<b>Details</b>]]
|| [[Trillium#GPU_instances|<b>Options</b>]] || H100-80gb || 90 || Two GPUs per CPU socket; all GPUs connected via NVLink
|-
| Arbutus || colspan=4|Cloud resources are not schedulable via Slurm. See [[Cloud resources]] for details of available hardware.
|}

<!--T:55-->
(*) <b>Compute Capability</b> is a technical term created by NVIDIA as a compact way to describe what hardware functions are available on some models of GPU and not on others. 
It is not a measure of performance and is relevant only if you are compiling your own GPU programs.  See the page on [[CUDA#.22Compute_Capability.22|CUDA programming]] for more.


<!--T:71-->
== Multi-Instance GPUs (MIGs) ==
MIG, a technology that allows to partition a GPU into multiple instances. Please see [[Multi-Instance_GPU]].

= Selecting the type of GPU to use = <!--T:16-->

<!--T:37-->
Some clusters have more than one GPU type available, and some clusters only have GPUs on certain nodes. 

<!--T:40-->
If you do not supply a type specifier, Slurm may send your job to a node equipped with any type of GPU.  
For certain workflows this may be undesirable; for example, molecular dynamics code requires high double-precision performance, for which T4 GPUs are not appropriate.
In such a case, make sure you include a type specifier.

= Requesting CPU cores and system memory = <!--T:75-->

<!--T:76-->
Along with each GPU instance, your job should have a number of CPU cores (default is <code>1</code>) and some amount of system memory. The recommended maximum numbers of CPU cores and gigabytes of system memory per GPU instance are listed in the [[Allocations_and_compute_scheduling#Ratios_in_bundles|table of bundle characteristics]].

= Examples = <!--T:62-->

<!--T:3-->
== Single-core job ==
If you need only a single CPU core and one GPU:
{{File
  |name=gpu_serial_job.sh
  |lang="sh"
  |contents=
#!/bin/bash
#SBATCH --account=def-someuser
#SBATCH --gpus-per-node=1
#SBATCH --mem=4000M               # memory per node
#SBATCH --time=0-03:00
./program                         # you can use 'nvidia-smi' for a test
}}

<!--T:4-->
== Multi-threaded job ==
For a GPU job which needs multiple CPUs in a single node:
{{File
  |name=gpu_threaded_job.sh
  |lang="sh"
  |contents=
#!/bin/bash
#SBATCH --account=def-someuser
#SBATCH --gpus-per-node=1         # Number of GPU(s) per node
#SBATCH --cpus-per-task=6         # CPU cores/threads
#SBATCH --mem=4000M               # memory per node
#SBATCH --time=0-03:00
export OMP_NUM_THREADS=$SLURM_CPUS_PER_TASK
./program
}}

<!--T:63-->
For each GPU requested, we recommend
* on Fir, no more than 12 CPU cores;
* on Narval, no more than 12 CPU cores
* on Nibi, no more than 14 CPU cores, 
* on Rorqual, no more than 16 CPU cores

<!--T:5-->
== MPI job ==
{{File
  |name=gpu_mpi_job.sh
  |lang="sh"
  |contents=
#!/bin/bash
#SBATCH --account=def-someuser
#SBATCH --gpus=8                  # total number of GPUs
#SBATCH --ntasks-per-gpu=1        # total of 8 MPI processes
#SBATCH --cpus-per-task=6         # CPU cores per MPI process
#SBATCH --mem-per-cpu=5G          # host memory per CPU core
#SBATCH --time=0-03:00            # time (DD-HH:MM)
export OMP_NUM_THREADS=$SLURM_CPUS_PER_TASK
srun --cpus-per-task=$SLURM_CPUS_PER_TASK ./program
}}

<!--T:6-->
== Whole nodes ==
If your application can efficiently use an entire node and its associated GPUs, you will probably experience shorter wait times if you ask Slurm for a whole node. Use one of the following job scripts as a template. 

===Packing single-GPU jobs within one SLURM job=== <!--T:12-->

<!--T:13-->
If you need to run four single-GPU programs or two 2-GPU programs for longer than 24 hours, [[GNU Parallel]] is recommended. A simple example is:
<pre>
cat params.input | parallel -j4 'CUDA_VISIBLE_DEVICES=$(({%} - 1)) python {} &> {#}.out'
</pre>
In this example, the GPU ID is calculated by subtracting 1 from the slot ID {%} and {#} is the job ID, starting from 1.

<!--T:14-->
A <code>params.input</code> file should include input parameters in each line, like this:
<pre>
code1.py
code2.py
code3.py
code4.py
...
</pre>
With this method, you can run multiple tasks in one submission. The <code>-j4</code> parameter means that GNU Parallel can run a maximum of four concurrent tasks, launching another as soon as one ends. CUDA_VISIBLE_DEVICES is used to ensure that two tasks do not try to use the same GPU at the same time.

== Profiling GPU tasks == <!--T:65-->

<!--T:77-->
On Fir and Nibi, GPU profiling is not available since performance counters are not accessible.

<!--T:66-->
On [[Narval/en|Narval]] and [[Rorqual/en|Rorqual]], profiling is possible but requires disabling the
[https://developer.nvidia.com/dcgm NVIDIA Data Center GPU Manager (DCGM)]. This must be done during job submission by setting the <code>DISABLE_DCGM</code> environment variable:

<!--T:72-->
{{Command|DISABLE_DCGM{{=}}1 salloc --account{{=}}def-someuser --gpus-per-node{{=}}1 --mem{{=}}4000M --time{{=}}03:00}}

<!--T:73-->
Then, in your interactive job, wait until DCGM is disabled on the node: 
{{Command|while [ ! -z "$(dcgmi -v {{!}} grep 'Hostengine build info:')" ]; do  sleep 5; done}}

<!--T:74-->
Finally, launch your profiler. For more details on profilers, see [[Debugging and profiling]].

<!--T:54-->
[[Category:SLURM]]
</translate>